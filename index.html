<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sk√≥ladagatal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; position: relative; }
        .header h1 { color: #333; font-size: 28px; margin-bottom: 10px; }
        .header .school-year { color: #666; font-size: 18px; font-weight: 500; }
        .change-btn { position: absolute; top: 20px; right: 20px; background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; display: none; }
        .change-btn:hover { background: #f57c00; transform: translateY(-2px); }
        .upload-section { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .upload-btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%; transition: all 0.3s ease; }
        .upload-btn:hover { background: #5568d3; transform: translateY(-2px); }
        .file-input { display: none; }
        .info-text { color: #666; font-size: 14px; margin-top: 10px; }
        .controls { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; }
        .control-row { display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 15px; }
        .control-row:last-child { margin-bottom: 0; }
        .week-selector { display: flex; align-items: center; gap: 15px; flex: 1; }
        .week-selector select { flex: 1; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; }
        .nav-buttons { display: flex; gap: 10px; }
        .nav-btn { background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        .nav-btn:hover { background: #5568d3; transform: translateY(-2px); }
        .nav-btn:disabled { background: #ccc; cursor: not-allowed; }
        .week-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; }
        .week-header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #f0f0f0; }
        .week-title { font-size: 24px; color: #333; margin-bottom: 5px; }
        .week-dates { font-size: 16px; color: #666; }
        .days-grid { display: grid; gap: 15px; }
        .day-card { background: #f8f9fa; border-radius: 10px; padding: 15px; border-left: 4px solid #e0e0e0; transition: all 0.3s ease; }
        .day-card:hover { background: #f0f2f5; transform: translateX(5px); }
        .day-card.has-event { border-left-color: #667eea; background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); }
        .day-card.weekend { background: #fff8f0; border-left-color: #ffa726; }
        .day-card.weekend.has-event { background: linear-gradient(135deg, #fffaf5 0%, #fff0e5 100%); border-left-color: #ff9800; }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .day-name { font-weight: 600; font-size: 18px; color: #333; }
        .day-date { font-size: 14px; color: #666; font-weight: 500; }
        .events { display: flex; flex-direction: column; gap: 8px; }
        .event-tag { background: #667eea; color: white; padding: 8px 12px; border-radius: 6px; font-size: 14px; font-weight: 500; }
        .event-tag.special { background: #ff5722; }
        .event-tag.starfsdagur { background: #4caf50; }
        .event-tag.fri { background: #ff9800; }
        .no-events { color: #999; font-style: italic; font-size: 14px; }
        .loading { text-align: center; padding: 40px; color: #666; font-size: 18px; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 15% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { font-size: 24px; font-weight: 600; color: #333; margin-bottom: 15px; }
        .modal-text { color: #666; margin-bottom: 25px; line-height: 1.6; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        .modal-btn.cancel { background: #e0e0e0; color: #666; }
        .modal-btn.cancel:hover { background: #d0d0d0; }
        .modal-btn.confirm { background: #ff5722; color: white; }
        .modal-btn.confirm:hover { background: #e64a19; }

        @media (max-width: 768px) {
            .change-btn { position: static; width: 100%; margin-top: 15px; }
            .modal-content { margin: 30% auto; width: 95%; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Sk√≥ladagatal</h1>
            <div class="school-year" id="schoolInfo">Veldu PDF dagatal til a√∞ byrja</div>
            <button class="change-btn" id="changeBtn" onclick="showChangeModal()">üîÑ Skipta um dagatal</button>
        </div>

        <div class="upload-section" id="uploadSection">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                üìÑ Velja PDF dagatal
            </button>
            <div class="info-text">Hla√∞i√∞ inn PDF sk√≥ladagatali - allt er lesi√∞ sj√°lfkrafa!</div>
            <input type="file" id="fileInput" class="file-input" accept=".pdf">
        </div>

        <div class="controls" id="controls">
            <div class="control-row">
                <div class="week-selector">
                    <select id="weekSelect"></select>
                </div>
            </div>
            <div class="control-row">
                <div class="nav-buttons">
                    <button class="nav-btn" id="prevBtn">‚óÄ Fyrri</button>
                    <button class="nav-btn" id="nextBtn">N√¶sta ‚ñ∂</button>
                </div>
            </div>
        </div>

        <div class="week-card" id="weekDisplay"></div>
    </div>

    <!-- Modal for changing calendar -->
    <div id="changeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Skipta um dagatal?</div>
            <div class="modal-text">
                √ûetta mun skipta √∫t n√∫verandi dagatalinu og hla√∞a inn n√Ωju PDF skjali.
                <br><br>
                Ertu viss um a√∞ √æ√∫ viljir halda √°fram?
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="hideChangeModal()">H√¶tta vi√∞</button>
                <button class="modal-btn confirm" onclick="confirmChange()">J√°, skipta</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let calendarData = null;
        let currentWeekIndex = 0;

        function showChangeModal() {
            document.getElementById('changeModal').style.display = 'block';
        }

        function hideChangeModal() {
            document.getElementById('changeModal').style.display = 'none';
        }

        function confirmChange() {
            hideChangeModal();
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                await processPDF(file);
            }
            e.target.value = ''; // Reset file input
        });

        async function processPDF(file) {
            const display = document.getElementById('weekDisplay');
            display.innerHTML = '<div class="loading">‚è≥ Les PDF skjal og dregur √∫t vi√∞bur√∞i...</div>';
            display.style.display = 'block';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();
                
                // Get text - join items on same line properly
                const textItems = textContent.items.map(item => ({
                    text: item.str,
                    x: item.transform[4],
                    y: item.transform[5]
                }));
                
                // Group by Y coordinate (lines)
                const lineGroups = {};
                textItems.forEach(item => {
                    const y = Math.round(item.y);
                    if (!lineGroups[y]) lineGroups[y] = [];
                    lineGroups[y].push(item);
                });
                
                // Sort by Y (descending) and build lines
                const sortedYs = Object.keys(lineGroups).map(Number).sort((a, b) => b - a);
                const lines = sortedYs.map(y => {
                    const items = lineGroups[y].sort((a, b) => a.x - b.x);
                    return items.map(item => item.text).join('');
                });
                
                console.log('Fj√∂ldi l√≠na:', lines.length);
                console.log('Fyrstu 10 l√≠nur:', lines.slice(0, 10));
                
                // Extract school name
                let schoolName = 'Sk√≥li';
                for (let line of lines.slice(0, 5)) {
                    if (line.includes('Nafn sk√≥la:')) {
                        const parts = line.split('Nafn sk√≥la:');
                        if (parts.length > 1) {
                            schoolName = parts[1].split(',')[0].trim();
                        }
                        break;
                    }
                }
                
                // Extract school year
                let schoolYear = null;
                for (let line of lines.slice(0, 10)) {
                    const match = line.match(/(\d{4})\s*-\s*(\d{4})/);
                    if (match) {
                        schoolYear = `${match[1]}-${match[2]}`;
                        break;
                    }
                }
                
                if (!schoolYear) {
                    alert('Gat ekki fundi√∞ sk√≥la√°r √≠ PDF. Vinsamlegast athuga√∞u a√∞ PDF s√© r√©tt sni√∞.');
                    display.style.display = 'none';
                    return;
                }
                
                console.log('Sk√≥li:', schoolName);
                console.log('√År:', schoolYear);
                
                // Parse events
                const events = parseEvents(lines, schoolYear);
                console.log('Fj√∂ldi vi√∞bur√∞a:', Object.keys(events).length);
                
                if (Object.keys(events).length === 0) {
                    alert('Gat ekki fundi√∞ neina vi√∞bur√∞i √≠ PDF. Vinsamlegast athuga√∞u a√∞ PDF s√© r√©tt sni√∞.');
                    display.style.display = 'none';
                    return;
                }
                
                // Generate weeks
                const weeks = generateWeeks(events, schoolYear);
                console.log('Fj√∂ldi vikna:', weeks.length);
                
                if (weeks.length === 0) {
                    alert('Gat ekki b√∫i√∞ til vikur. Athuga√∞u dagsetningar √≠ PDF.');
                    display.style.display = 'none';
                    return;
                }
                
                calendarData = { school: schoolName, year: schoolYear, weeks: weeks };
                
                document.getElementById('schoolInfo').textContent = `${schoolName} ‚Ä¢ ${schoolYear}`;
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('changeBtn').style.display = 'block';
                document.getElementById('controls').style.display = 'block';
                
                currentWeekIndex = findCurrentWeek();
                populateWeekSelector();
                displayWeek(currentWeekIndex);
                
            } catch (error) {
                console.error('Villa:', error);
                alert('Villa vi√∞ a√∞ lesa PDF: ' + error.message);
                display.style.display = 'none';
            }
        }

        function parseEvents(lines, schoolYear) {
            const events = {};
            const months = ['√ÅG√öST', 'SEPTEMBER', 'OKT√ìBER', 'N√ìVEMBER', 'DESEMBER', 
                          'JAN√öAR', 'FEBR√öAR', 'MARS', 'APR√çL', 'MA√ç', 'J√öN√ç'];
            const monthNumbers = [8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6];
            
            const yearParts = schoolYear.split('-');
            const startYear = parseInt(yearParts[0]);
            
            const getYearForMonth = (monthNum) => monthNum >= 8 ? startYear : startYear + 1;
            
            let monthLineIdx = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('√ÅG√öST') && lines[i].includes('SEPTEMBER')) {
                    monthLineIdx = i;
                    console.log('Fann m√°nu√∞al√≠nu √≠ l√≠nu', i);
                    break;
                }
            }
            
            if (monthLineIdx === -1) {
                console.error('Gat ekki fundi√∞ m√°nu√∞al√≠nu');
                return events;
            }
            
            for (let lineIdx = monthLineIdx + 1; lineIdx < lines.length; lineIdx++) {
                const line = lines[lineIdx];
                
                if (line.includes('Samkv√¶mt') || line.includes('S√©rstakir') || line.includes('Starfsdagar')) {
                    break;
                }
                
                if (!line.trim()) continue;
                
                const parts = line.trim().split(/\s+/);
                if (!parts[0]) continue;
                
                const firstPart = parts[0].replace(/[SM√ûFL]/gi, '');
                if (!firstPart || isNaN(firstPart)) continue;
                
                const dayNum = parseInt(firstPart);
                const regex = new RegExp(`\\b${dayNum}\\s*[SM√ûFL]?\\s*`, 'gi');
                const splitParts = line.split(regex);
                const monthParts = splitParts.slice(1);
                
                for (let monthIdx = 0; monthIdx < Math.min(monthParts.length, months.length); monthIdx++) {
                    const part = monthParts[monthIdx];
                    const cleanText = part.replace(/\s*\d+\s*[SM√ûFL]?.*$/i, '').trim();
                    
                    if (cleanText && cleanText.length > 1 && !/^[SM√ûFL\s]*$/i.test(cleanText)) {
                        const monthNum = monthNumbers[monthIdx];
                        const year = getYearForMonth(monthNum);
                        const dateKey = `${year}-${monthNum}-${dayNum}`;
                        
                        const eventList = cleanText.includes('/') ? cleanText.split('/') : [cleanText];
                        if (!events[dateKey]) events[dateKey] = [];
                        
                        eventList.forEach(e => {
                            const clean = e.trim();
                            if (clean && !events[dateKey].includes(clean)) {
                                events[dateKey].push(clean);
                            }
                        });
                    }
                }
            }
            
            return events;
        }

        function generateWeeks(events, schoolYear) {
            const allDates = [];
            
            for (let dateStr in events) {
                try {
                    const [year, month, day] = dateStr.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    
                    if (!isNaN(date.getTime()) && 
                        date.getFullYear() === year && 
                        date.getMonth() === month - 1 && 
                        date.getDate() === day) {
                        allDates.push(date);
                    }
                } catch (e) {
                    console.warn('√ìgild dagsetning:', dateStr);
                }
            }
            
            if (allDates.length === 0) {
                console.error('Engar gildar dagsetningar fundust');
                return [];
            }
            
            const minDate = new Date(Math.min(...allDates));
            const maxDate = new Date(Math.max(...allDates));
            
            console.log('Dagsetningabil:', minDate.toISOString().split('T')[0], 'til', maxDate.toISOString().split('T')[0]);
            
            const startDate = new Date(minDate);
            const dayOfWeek = startDate.getDay();
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            startDate.setDate(startDate.getDate() + daysToMonday);
            
            const endDate = new Date(maxDate);
            const daysToSunday = 7 - endDate.getDay();
            if (daysToSunday < 7) {
                endDate.setDate(endDate.getDate() + daysToSunday);
            }
            
            const weeks = [];
            const current = new Date(startDate);
            let weekNumber = 1;
            
            const weekdayNames = ['M√°nudagur', '√ûri√∞judagur', 'Mi√∞vikudagur', 'Fimmtudagur', 'F√∂studagur', 'Laugardagur', 'Sunnudagur'];
            const monthNames = ['', 'jan√∫ar', 'febr√∫ar', 'mars', 'apr√≠l', 'ma√≠', 'j√∫n√≠', 'j√∫l√≠', '√°g√∫st', 'september', 'okt√≥ber', 'n√≥vember', 'desember'];
            
            while (current <= endDate) {
                const week = {
                    week_number: weekNumber,
                    start_date: current.toISOString().split('T')[0],
                    days: []
                };
                
                for (let i = 0; i < 7; i++) {
                    const day = new Date(current);
                    day.setDate(current.getDate() + i);
                    
                    const dateKey = `${day.getFullYear()}-${day.getMonth() + 1}-${day.getDate()}`;
                    const dayEvents = events[dateKey] || [];
                    
                    week.days.push({
                        date: day.toISOString().split('T')[0],
                        weekday: weekdayNames[i],
                        day_number: day.getDate(),
                        month: monthNames[day.getMonth() + 1],
                        events: [...dayEvents]
                    });
                }
                
                weeks.push(week);
                weekNumber++;
                current.setDate(current.getDate() + 7);
            }
            
            console.log('Fj√∂ldi vikna:', weeks.length);
            return weeks;
        }

        function findCurrentWeek() {
            if (!calendarData || !calendarData.weeks || calendarData.weeks.length === 0) return 0;
            const today = new Date().toISOString().split('T')[0];
            const index = calendarData.weeks.findIndex(week => {
                const start = new Date(week.start_date);
                const end = new Date(week.days[6].date);
                const current = new Date(today);
                return current >= start && current <= end;
            });
            return index === -1 ? 0 : index;
        }

        function populateWeekSelector() {
            const select = document.getElementById('weekSelect');
            select.innerHTML = '';
            calendarData.weeks.forEach((week, index) => {
                const option = document.createElement('option');
                option.value = index;
                const start = new Date(week.start_date);
                const end = new Date(week.days[6].date);
                option.textContent = `Vika ${week.week_number}: ${start.getDate()}. ${start.getMonth()+1}. - ${end.getDate()}. ${end.getMonth()+1}.`;
                select.appendChild(option);
            });
            select.value = currentWeekIndex;
            select.addEventListener('change', (e) => {
                currentWeekIndex = parseInt(e.target.value);
                displayWeek(currentWeekIndex);
            });
        }

        function displayWeek(weekIndex) {
            const week = calendarData.weeks[weekIndex];
            const display = document.getElementById('weekDisplay');
            const start = new Date(week.start_date);
            const end = new Date(week.days[6].date);
            
            let html = `<div class="week-header"><div class="week-title">Vika ${week.week_number}</div><div class="week-dates">${start.getDate()}. ${start.getMonth()+1}. - ${end.getDate()}. ${end.getMonth()+1}.</div></div><div class="days-grid">`;
            
            week.days.forEach(day => {
                const isWeekend = day.weekday === 'Laugardagur' || day.weekday === 'Sunnudagur';
                const hasEvents = day.events && day.events.length > 0;
                const eventClass = hasEvents ? 'has-event' : '';
                const weekendClass = isWeekend ? 'weekend' : '';
                
                html += `<div class="day-card ${eventClass} ${weekendClass}"><div class="day-header"><div class="day-name">${day.weekday}</div><div class="day-date">${day.day_number}. ${day.month}</div></div><div class="events">`;
                
                if (hasEvents) {
                    day.events.forEach(event => {
                        let className = '';
                        if (event.toLowerCase().includes('starfsdagur')) className = 'starfsdagur';
                        else if (event.toLowerCase().includes('fr√≠') || event.toLowerCase().includes('dagur')) className = 'fri';
                        else if (event.toLowerCase().match(/sk√≥laslit|sk√≥lasetning|√°rsh√°t√≠√∞|j√≥l/)) className = 'special';
                        html += `<span class="event-tag ${className}">${event}</span>`;
                    });
                } else {
                    html += '<span class="no-events">Engir s√©rstakir vi√∞bur√∞ir</span>';
                }
                
                html += '</div></div>';
            });
            
            html += '</div>';
            display.innerHTML = html;
            display.style.display = 'block';
            
            document.getElementById('prevBtn').disabled = weekIndex === 0;
            document.getElementById('nextBtn').disabled = weekIndex === calendarData.weeks.length - 1;
            document.getElementById('weekSelect').value = weekIndex;
        }

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentWeekIndex > 0) {
                currentWeekIndex--;
                displayWeek(currentWeekIndex);
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentWeekIndex < calendarData.weeks.length - 1) {
                currentWeekIndex++;
                displayWeek(currentWeekIndex);
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('changeModal');
            if (event.target == modal) {
                hideChangeModal();
            }
        }
    </script>
</body>
</html>
