<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sk√≥ladagatal - Lundarsk√≥li</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #e0f2fe 0%, #ddd6fe 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .week-header {
      background: linear-gradient(90deg, #6366f1 0%, #a855f7 100%);
      color: white;
      padding: 2rem;
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .day-card {
      background: white;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: stretch;
    }
    .day-header {
      background-color: #6366f1;
      color: white;
      padding: 1rem;
      text-align: center;
      min-width: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .day-body {
      padding: 1rem;
      flex: 1;
      display: flex;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">
        
        <!-- Upload Section -->
        <div id="upload-section" class="card shadow-lg mb-4">
          <div class="card-body p-5 text-center">
            <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mb-4 mx-auto text-primary">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <h1 class="h2 mb-3 fw-bold">Sk√≥ladagatal</h1>
            <p class="text-muted mb-4">Hladdu inn PDF sk√≥ladagatali til a√∞ byrja</p>
            
            <label class="btn btn-primary btn-lg px-5">
              üìÑ Velja PDF skjal
              <input type="file" id="pdf-upload" accept="application/pdf" class="d-none">
            </label>
            
            <div id="upload-status" class="mt-3"></div>
          </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendar-section" class="d-none">
          <div class="card shadow-lg">
            <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-4">
              <div class="d-flex align-items-center">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="me-3">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <div>
                  <h1 class="h2 mb-0 fw-bold">Sk√≥ladagatal</h1>
                  <div class="small text-muted" id="calendar-title">Lundarsk√≥li 2025-26</div>
                </div>
              </div>
              <button id="reset-btn" class="btn btn-outline-secondary">
                üîÑ Skipta um PDF
              </button>
            </div>

            <div class="mb-3 text-muted small d-flex align-items-center gap-3 flex-wrap">
              <span id="week-info">üìÑ Sk√≥ladagatal</span>
              <div class="d-flex align-items-center gap-2">
                <span class="badge" style="background-color: #fcebb4;">S√©rstakir dagar</span>
                <span class="badge" style="background-color: #dab494;">Fr√≠dagar/Fr√≠</span>
                <span class="badge" style="background-color: #96b3d6;">Starfsdagar</span>
                <span class="badge" style="background-color: #8eb4e2;">Vi√∞bur√∞ir</span>
              </div>
            </div>

            <div class="week-header">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <button id="prev-btn" class="btn btn-light btn-lg">‚Üê</button>
                <div class="text-center">
                  <div class="display-4 fw-bold mb-2">Vika <span id="week-number"></span></div>
                  <div class="fs-5" id="week-dates"></div>
                  <div class="small mt-1" id="week-year"></div>
                </div>
                <button id="next-btn" class="btn btn-light btn-lg">‚Üí</button>
              </div>
              <div class="text-center small">
                <span id="week-counter"></span>
              </div>
            </div>

            <div class="bg-light rounded-3 p-4">
              <div id="days-container"></div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentWeekIndex = 0;
    let weeks = [];

    function showCalendar() {
      document.getElementById('upload-section').classList.add('d-none');
      document.getElementById('calendar-section').classList.remove('d-none');
      document.getElementById('week-info').textContent = `üìÑ ${weeks.length} vikur`;
      
      // Find current week
      const currentWeek = getCurrentWeekNumber();
      const weekIndex = weeks.findIndex(w => parseInt(w.weekNumber) === currentWeek);
      
      if (weekIndex !== -1) {
        currentWeekIndex = weekIndex;
      } else {
        // If current week not found, default to first week
        currentWeekIndex = 0;
      }
      
      renderWeek();
    }
    
    function getCurrentWeekNumber() {
      // Get current date
      const now = new Date();
      
      // Get first day of the year
      const start = new Date(now.getFullYear(), 0, 1);
      
      // Calculate the week number (ISO 8601)
      const diff = now - start;
      const oneWeek = 1000 * 60 * 60 * 24 * 7;
      const weekNum = Math.ceil((diff / oneWeek) + ((start.getDay() + 1) / 7));
      
      return weekNum;
    }

    function showUpload() {
      document.getElementById('upload-section').classList.remove('d-none');
      document.getElementById('calendar-section').classList.add('d-none');
      weeks = [];
      currentWeekIndex = 0;
    }

    // Reset button
    document.getElementById('reset-btn').addEventListener('click', () => {
      showUpload();
    });

    // PDF upload with Claude API parsing
    document.getElementById('pdf-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      document.getElementById('upload-status').innerHTML = 
        '<div class="alert alert-info">üìÑ ' + file.name + ' er a√∞ hla√∞ast inn...</div>';
      
      try {
        // Convert PDF to base64
        const base64Data = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        
        document.getElementById('upload-status').innerHTML = 
          '<div class="alert alert-info">ü§ñ Claude er a√∞ √æ√°tta dagatali√∞...</div>';
        
        // Call Claude API to parse the PDF
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 32000,
            messages: [{
              role: 'user',
              content: [
                {
                  type: 'document',
                  source: {
                    type: 'base64',
                    media_type: 'application/pdf',
                    data: base64Data
                  }
                },
                {
                  type: 'text',
                  text: `√û√°ttu ALLT sk√≥ladagatali√∞ og skila√∞u BARA JSON.

MJ√ñG MIKILV√ÜGT:
- Skila√∞u √ñLLUM vikum √≠ dagatalinu, ekki bara hluta
- Nota√∞u STUTTAR l√Ωsingar (max 3-4 or√∞)
- ENGAR markdown code blocks
- JSON √° EINNI L√çNU

FORMAT (ekkert indent, ekkert line break):
{"weeks":[{"weekNumber":"32","dates":"4.-8. √°g√∫st","year":"2025","days":[{"dayLetter":"M","date":"4","events":["Vi√∞bur√∞ur"],"color":"beige"},{"dayLetter":"√û","date":"5","events":[]}]}]}

LITIR (bara ef bakgrunnslitur):
beige=lj√≥sbr√∫nn, brown=fr√≠dagar, blue=starfsdagar, lightblue=vi√∞bur√∞ir

STUTTAR l√Ωsingar:
‚úì "Starfsdagur" ekki "Starfsdagur kennara"
‚úì "Haustfr√≠" ekki "Haustfr√≠ fyrir nemendur"
‚úì "Samt√∂l" ekki "Foreldrasamt√∂l"

Skila√∞u JSON fyrir ALLAR vikurnar √° einni l√≠nu.`
                }
              ]
            }]
          })
        });
        
        if (!response.ok) {
          throw new Error('API villa: ' + response.status);
        }
        
        const data = await response.json();
        let content = data.content[0].text;
        
        console.log('Raw response length:', content.length);
        console.log('First 200 chars:', content.substring(0, 200));
        console.log('Last 200 chars:', content.substring(content.length - 200));
        
        // Remove markdown code blocks
        content = content.replace(/```json\s*/g, '').replace(/```\s*/g, '');
        
        // Find the JSON object boundaries
        const firstBrace = content.indexOf('{');
        const lastBrace = content.lastIndexOf('}');
        
        if (firstBrace === -1 || lastBrace === -1) {
          throw new Error('Fann ekki JSON √≠ svarinu');
        }
        
        let jsonText = content.substring(firstBrace, lastBrace + 1);
        
        console.log('Extracted JSON length:', jsonText.length);
        
        // Try parsing directly first
        let parsedData;
        try {
          parsedData = JSON.parse(jsonText);
          console.log('JSON parsed successfully on first try');
        } catch (firstError) {
          console.error('First parse failed:', firstError.message);
          
          // Show more context around the error
          const errorPos = parseInt(firstError.message.match(/position (\d+)/)?.[1] || '0');
          console.log('Error context:', jsonText.substring(Math.max(0, errorPos - 100), Math.min(jsonText.length, errorPos + 100)));
          
          // Try aggressive cleanup
          document.getElementById('upload-status').innerHTML = 
            '<div class="alert alert-info">üîß Reyni a√∞ laga JSON format...</div>';
          
          // Remove all newlines and extra spaces
          jsonText = jsonText.replace(/\s+/g, ' ');
          
          // Fix common issues
          jsonText = jsonText
            .replace(/,\s*}/g, '}')  // Remove trailing commas before }
            .replace(/,\s*]/g, ']')  // Remove trailing commas before ]
            .replace(/}\s*{/g, '},{') // Add comma between objects
            .replace(/]\s*\[/g, '],['); // Add comma between arrays
          
          try {
            parsedData = JSON.parse(jsonText);
            console.log('JSON parsed after cleanup');
          } catch (secondError) {
            console.error('Second parse also failed:', secondError.message);
            throw new Error('Gat ekki √æ√°tta√∞ JSON. Reyndu aftur me√∞ √∂√∞ru PDF e√∞a minni PDF.');
          }
        }
        
        if (parsedData.weeks && parsedData.weeks.length > 0) {
          weeks = parsedData.weeks;
          
          // Show what was parsed
          const firstWeek = weeks[0];
          const lastWeek = weeks[weeks.length - 1];
          const weeksInfo = `${weeks.length} vikur (vika ${firstWeek.weekNumber} til ${lastWeek.weekNumber})`;
          
          document.getElementById('calendar-title').textContent = file.name.replace('.pdf', '');
          document.getElementById('upload-status').innerHTML = 
            `<div class="alert alert-success">‚úÖ Dagatal √æ√°tta√∞! ${weeksInfo}
            <br><small class="text-muted">Ef √æetta er ekki allt sk√≥la√°ri√∞, reyndu a√∞ nota minni PDF e√∞a skipta √æv√≠ upp.</small></div>`;
          
          setTimeout(() => showCalendar(), 2000);
        } else {
          throw new Error('Engar vikur fundust √≠ PDF');
        }
        
      } catch (error) {
        console.error('Villa vi√∞ √æ√°ttun:', error);
        document.getElementById('upload-status').innerHTML = 
          '<div class="alert alert-danger">‚ùå Villa vi√∞ √æ√°ttun: ' + error.message + 
          '<br><small>Reyndu aftur e√∞a nota√∞u s√Ωnig√∂gnin.</small></div>';
      }
    });

    function renderWeek() {
      const week = weeks[currentWeekIndex];
      if (!week) return;

      document.getElementById('week-number').textContent = week.weekNumber;
      document.getElementById('week-dates').textContent = week.dates;
      document.getElementById('week-year').textContent = week.year || '';
      document.getElementById('week-counter').textContent = 
        `${currentWeekIndex + 1} af ${weeks.length} vikum`;

      document.getElementById('prev-btn').disabled = currentWeekIndex === 0;
      document.getElementById('next-btn').disabled = currentWeekIndex === weeks.length - 1;

      const daysContainer = document.getElementById('days-container');
      daysContainer.innerHTML = '';
      
      week.days.forEach((day) => {
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        
        // Litur √∫t fr√° vi√∞bur√∞i
        const colorMap = {
          'beige': '#fcebb4',
          'brown': '#dab494',
          'blue': '#96b3d6',
          'lightblue': '#8eb4e2'
        };
        const bgColor = day.color ? colorMap[day.color] : 'white';
        
        dayCard.innerHTML = `
          <div class="day-header">
            <div class="fs-4 fw-bold">
              ${day.date ? `${day.date}. ` : ''}${day.dayLetter}
            </div>
          </div>
          <div class="day-body" style="background-color: ${bgColor};">
            ${day.events && day.events.length > 0 ? 
              `<ul class="list-unstyled mb-0 w-100">
                ${day.events.map(event => `
                  <li class="text-secondary mb-2 d-flex align-items-start">
                    <span class="text-primary me-2">‚Ä¢</span>
                    <span>${event}</span>
                  </li>
                `).join('')}
              </ul>` :
              '<span class="text-muted">Engir vi√∞bur√∞ir</span>'
            }
          </div>
        `;
        
        daysContainer.appendChild(dayCard);
      });
    }

    document.getElementById('prev-btn').addEventListener('click', () => {
      if (currentWeekIndex > 0) {
        currentWeekIndex--;
        renderWeek();
      }
    });

    document.getElementById('next-btn').addEventListener('click', () => {
      if (currentWeekIndex < weeks.length - 1) {
        currentWeekIndex++;
        renderWeek();
      }
    });
  </script>
</body>
</html>
