<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sk√≥ladagatal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .school-year {
            color: #666;
            font-size: 18px;
            font-weight: 500;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .upload-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .file-input {
            display: none;
        }

        .info-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .week-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .week-selector select {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .week-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-btn:active {
            transform: translateY(0);
        }

        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .week-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .week-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #f0f0f0;
        }

        .week-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 5px;
        }

        .week-dates {
            font-size: 16px;
            color: #666;
        }

        .days-grid {
            display: grid;
            gap: 15px;
        }

        .day-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .day-card:hover {
            background: #f0f2f5;
            transform: translateX(5px);
        }

        .day-card.has-event {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
        }

        .day-card.weekend {
            background: #fff8f0;
            border-left-color: #ffa726;
        }

        .day-card.weekend.has-event {
            background: linear-gradient(135deg, #fffaf5 0%, #fff0e5 100%);
            border-left-color: #ff9800;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .day-name {
            font-weight: 600;
            font-size: 18px;
            color: #333;
        }

        .day-date {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .events {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .event-tag {
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
        }

        .event-tag.special {
            background: #ff5722;
        }

        .event-tag.starfsdagur {
            background: #4caf50;
        }

        .event-tag.fri {
            background: #ff9800;
        }

        .no-events {
            color: #999;
            font-style: italic;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .control-row {
                flex-direction: column;
            }

            .week-selector {
                width: 100%;
            }

            .nav-buttons {
                width: 100%;
            }

            .nav-btn {
                flex: 1;
            }

            .week-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Sk√≥ladagatal</h1>
            <div class="school-year" id="schoolInfo">Veldu PDF dagatal</div>
        </div>

        <div class="upload-section" id="uploadSection">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                üìÑ Velja PDF dagatal
            </button>
            <div class="info-text">Veldu PDF skjal me√∞ sk√≥ladagatali til a√∞ byrja</div>
            <input type="file" id="fileInput" class="file-input" accept=".pdf">
        </div>

        <div class="controls" id="controls" style="display: none;">
            <div class="control-row">
                <div class="week-selector">
                    <select id="weekSelect"></select>
                </div>
            </div>
            <div class="control-row">
                <div class="nav-buttons">
                    <button class="nav-btn" id="prevBtn">‚óÄ Fyrri</button>
                    <button class="nav-btn" id="nextBtn">N√¶sta ‚ñ∂</button>
                </div>
            </div>
        </div>

        <div class="week-card" id="weekDisplay" style="display: none;"></div>
    </div>

    <script>
        // Set up PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let calendarData = null;
        let currentWeekIndex = 0;

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                await processPDF(file);
            } else if (file) {
                alert('Vinsamlegast veldu PDF skjal');
            }
        });

        async function processPDF(file) {
            try {
                document.getElementById('weekDisplay').innerHTML = '<div class="loading">‚è≥ Vinn √∫r PDF skjali...</div>';
                document.getElementById('weekDisplay').style.display = 'block';
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();
                
                const text = textContent.items.map(item => item.str).join('\n');
                const lines = text.split('\n');
                
                // Extract school year
                let schoolYear = '2025-2026';
                for (let line of lines.slice(0, 5)) {
                    const match = line.match(/(\d{4})\s*-\s*(\d{4})/);
                    if (match) {
                        schoolYear = `${match[1]}-${match[2]}`;
                        break;
                    }
                }
                
                // Extract school name
                let schoolName = 'Sk√≥li';
                for (let line of lines.slice(0, 5)) {
                    if (line.includes('Nafn sk√≥la:')) {
                        schoolName = line.split('Nafn sk√≥la:')[1].trim();
                        break;
                    }
                }

                console.log('Sk√≥li:', schoolName);
                console.log('√År:', schoolYear);

                // Parse events from PDF
                const events = parseEventsFromPDF(lines, schoolYear);
                console.log('Fj√∂ldi vi√∞bur√∞a:', Object.keys(events).length);

                // Generate weeks
                const weeks = generateWeeksData(events, schoolYear);

                calendarData = {
                    school: schoolName,
                    year: schoolYear,
                    weeks: weeks
                };

                document.getElementById('schoolInfo').textContent = `${schoolName} ‚Ä¢ ${schoolYear}`;
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('controls').style.display = 'block';
                
                currentWeekIndex = findCurrentWeek();
                populateWeekSelector();
                displayWeek(currentWeekIndex);

            } catch (error) {
                console.error('Villa:', error);
                alert('Villa vi√∞ a√∞ lesa PDF skjal. Vinsamlegast reyndu aftur.');
                document.getElementById('weekDisplay').style.display = 'none';
            }
        }

        function parseEventsFromPDF(lines, schoolYear) {
            const events = {};
            const months = ['√ÅG√öST', 'SEPTEMBER', 'OKT√ìBER', 'N√ìVEMBER', 'DESEMBER', 
                          'JAN√öAR', 'FEBR√öAR', 'MARS', 'APR√çL', 'MA√ç', 'J√öN√ç'];
            const monthNumbers = [8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6];
            
            const yearParts = schoolYear.split('-');
            const startYear = parseInt(yearParts[0]);
            
            function getYearForMonth(monthNum) {
                return monthNum >= 8 ? startYear : startYear + 1;
            }
            
            let monthLineIdx = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('√ÅG√öST') && lines[i].includes('SEPTEMBER')) {
                    monthLineIdx = i;
                    break;
                }
            }
            
            if (monthLineIdx === -1) return events;
            
            for (let lineIdx = monthLineIdx + 1; lineIdx < lines.length; lineIdx++) {
                const line = lines[lineIdx];
                
                if (line.includes('Samkv√¶mt') || line.includes('S√©rstakir') || line.includes('Starfsdagar')) {
                    break;
                }
                
                if (!line.trim()) continue;
                
                const parts = line.split(/\s+/);
                if (!parts[0]) continue;
                
                const dayNumStr = parts[0].replace(/[SM√ûFL]/g, '');
                if (!dayNumStr || isNaN(dayNumStr)) continue;
                
                const dayNum = parseInt(dayNumStr);
                
                // Parse events for each month
                const dayPattern = new RegExp(`\\b${dayNum}\\s*[SM√ûFL]?\\s+([^\\d]+?)(?=\\s+\\d+|$)`, 'g');
                let match;
                let eventIdx = 0;
                
                while ((match = dayPattern.exec(line)) !== null && eventIdx < months.length) {
                    let eventText = match[1].trim();
                    eventText = eventText.replace(/[SM√ûFL]\s*$/, '').trim();
                    
                    if (eventText && eventText.length > 1 && !/^[SM√ûFL\s]+$/.test(eventText)) {
                        const monthNum = monthNumbers[eventIdx];
                        const year = getYearForMonth(monthNum);
                        const dateKey = `${year}-${monthNum}-${dayNum}`;
                        
                        if (!events[dateKey]) {
                            events[dateKey] = [];
                        }
                        
                        const eventList = eventText.includes('/') ? eventText.split('/') : [eventText];
                        eventList.forEach(e => {
                            const cleanEvent = e.trim();
                            if (cleanEvent && !events[dateKey].includes(cleanEvent)) {
                                events[dateKey].push(cleanEvent);
                            }
                        });
                    }
                    eventIdx++;
                }
            }
            
            return events;
        }

        function generateWeeksData(events, yearStr) {
            const yearParts = yearStr.split('-');
            const startYear = parseInt(yearParts[0]);
            
            const startDate = new Date(startYear, 7, 18);
            const endDate = new Date(startYear + 1, 5, 14);
            
            const weeks = [];
            let currentDate = new Date(startDate);
            let weekNumber = 1;
            
            const weekdayNames = [
                'M√°nudagur', '√ûri√∞judagur', 'Mi√∞vikudagur',
                'Fimmtudagur', 'F√∂studagur', 'Laugardagur', 'Sunnudagur'
            ];
            
            const monthNames = [
                '', 'jan√∫ar', 'febr√∫ar', 'mars', 'apr√≠l', 'ma√≠', 'j√∫n√≠',
                'j√∫l√≠', '√°g√∫st', 'september', 'okt√≥ber', 'n√≥vember', 'desember'
            ];
            
            while (currentDate <= endDate) {
                const daysToMonday = currentDate.getDay() === 0 ? -6 : 1 - currentDate.getDay();
                const monday = new Date(currentDate);
                monday.setDate(monday.getDate() + daysToMonday);
                
                const weekData = {
                    week_number: weekNumber,
                    start_date: monday.toISOString().split('T')[0],
                    days: []
                };
                
                for (let i = 0; i < 7; i++) {
                    const day = new Date(monday);
                    day.setDate(monday.getDate() + i);
                    
                    const dayKey = `${day.getFullYear()}-${day.getMonth() + 1}-${day.getDate()}`;
                    const dayEvents = events[dayKey] || [];
                    
                    weekData.days.push({
                        date: day.toISOString().split('T')[0],
                        weekday: weekdayNames[i],
                        day_number: day.getDate(),
                        month: monthNames[day.getMonth() + 1],
                        events: [...dayEvents]
                    });
                }
                
                weeks.push(weekData);
                weekNumber++;
                currentDate.setDate(currentDate.getDate() + 7);
            }
            
            return weeks;
        }

        function findCurrentWeek() {
            if (!calendarData) return 0;
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            const index = calendarData.weeks.findIndex(week => {
                const weekStart = new Date(week.start_date);
                const weekEnd = new Date(week.days[6].date);
                const todayDate = new Date(todayStr);
                return todayDate >= weekStart && todayDate <= weekEnd;
            });

            return index === -1 ? 0 : index;
        }

        function populateWeekSelector() {
            const select = document.getElementById('weekSelect');
            select.innerHTML = '';

            calendarData.weeks.forEach((week, index) => {
                const option = document.createElement('option');
                option.value = index;
                const startDate = formatDateIcelandic(new Date(week.start_date));
                const endDate = formatDateIcelandic(new Date(week.days[6].date));
                option.textContent = `Vika ${week.week_number}: ${startDate} - ${endDate}`;
                select.appendChild(option);
            });

            select.value = currentWeekIndex;
            select.addEventListener('change', (e) => {
                currentWeekIndex = parseInt(e.target.value);
                displayWeek(currentWeekIndex);
            });
        }

        function formatDateIcelandic(date) {
            return `${date.getDate()}. ${date.getMonth() + 1}.`;
        }

        function formatFullDate(dateStr) {
            const date = new Date(dateStr);
            const monthNames = ['', 'jan√∫ar', 'febr√∫ar', 'mars', 'apr√≠l', 'ma√≠', 'j√∫n√≠',
                               'j√∫l√≠', '√°g√∫st', 'september', 'okt√≥ber', 'n√≥vember', 'desember'];
            return `${date.getDate()}. ${monthNames[date.getMonth() + 1]}`;
        }

        function getEventClass(event) {
            const lowerEvent = event.toLowerCase();
            if (lowerEvent.includes('starfsdagur')) return 'starfsdagur';
            if (lowerEvent.includes('fr√≠') || lowerEvent.includes('dagur')) return 'fri';
            if (lowerEvent.includes('sk√≥laslit') || lowerEvent.includes('sk√≥lasetning') || 
                lowerEvent.includes('√°rsh√°t√≠√∞') || lowerEvent.includes('j√≥l')) return 'special';
            return '';
        }

        function displayWeek(weekIndex) {
            const week = calendarData.weeks[weekIndex];
            const display = document.getElementById('weekDisplay');

            const startDate = formatDateIcelandic(new Date(week.start_date));
            const endDate = formatDateIcelandic(new Date(week.days[6].date));

            let html = `
                <div class="week-header">
                    <div class="week-title">Vika ${week.week_number}</div>
                    <div class="week-dates">${startDate} - ${endDate}</div>
                </div>
                <div class="days-grid">
            `;

            week.days.forEach(day => {
                const isWeekend = day.weekday === 'Laugardagur' || day.weekday === 'Sunnudagur';
                const hasEvents = day.events && day.events.length > 0;
                
                html += `
                    <div class="day-card ${hasEvents ? 'has-event' : ''} ${isWeekend ? 'weekend' : ''}">
                        <div class="day-header">
                            <div class="day-name">${day.weekday}</div>
                            <div class="day-date">${formatFullDate(day.date)}</div>
                        </div>
                        <div class="events">
                `;

                if (hasEvents) {
                    day.events.forEach(event => {
                        const eventClass = getEventClass(event);
                        html += `<span class="event-tag ${eventClass}">${event}</span>`;
                    });
                } else {
                    html += `<span class="no-events">Engir s√©rstakir vi√∞bur√∞ir</span>`;
                }

                html += `
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            display.innerHTML = html;

            document.getElementById('prevBtn').disabled = weekIndex === 0;
            document.getElementById('nextBtn').disabled = weekIndex === calendarData.weeks.length - 1;
            document.getElementById('weekSelect').value = weekIndex;
        }

        // Navigation
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentWeekIndex > 0) {
                currentWeekIndex--;
                displayWeek(currentWeekIndex);
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentWeekIndex < calendarData.weeks.length - 1) {
                currentWeekIndex++;
                displayWeek(currentWeekIndex);
            }
        });
    </script>
</body>
</html>
